{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/memory_test.css') }}">

<div class="container text-center mt-5">
    <h2>Short-Term Memory Test</h2>

    <!-- flash message confirmation for instructions -->
    {% with messages = get_flashed_messages(category_filter=["memory_test"]) %}
        {% if messages %}
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                {{ messages[0]|safe }}
                <hr>
                <button id="confirm-no" class="btn btn-danger">No</button>
                <button id="confirm-yes" class="btn btn-success">Yes</button>
            </div>
        {% endif %}
    {% endwith %}

    <!-- memory test frame hidden initially -->
    <div id="test-frame" class="{{ 'visible' if show_test else 'hidden' }}">
        <h2>Round {{ round_num }}</h2>
        <div id="shapes-frame">
            {% for shape in shapes %}
                <div class="shape {{ shape }}" 
                    style="background-color: {{ shape_colours[loop.index0] }};
                    top: {{ shape_positions[loop.index0].top }}px;
                    left: {{ shape_positions[loop.index0].left }}px;">
                </div>
            {% endfor %}
        </div>

        {% if buttons_enabled %}
            <form method="POST" action="{{ url_for('memory_test.memory_test_view') }}">
                <input type="hidden" name="reaction_time" id="reaction_time">
                <button type="submit" name="choice" value="Same" class="btn btn-success btn-lg">Same</button>
                <button type="submit" name="choice" value="Different" class="btn btn-danger btn-lg">Different</button>
            </form>
        {% endif %}
    </div>
</div>

<script>
    const yesBtn = document.getElementById('confirm-yes');
    const noBtn = document.getElementById('confirm-no');
    const testFrame = document.getElementById('test-frame');
    const alertBox = yesBtn ? yesBtn.parentElement : null;

    // Handle leaving via back button
    // Replace current history entry with a custom state object, {page:1}
    // so the page exists in the stack
    history.replaceState({page:1}, null, location.href);
    // Push a dummy state {page:2} on top so the back button triggers popstate
    history.pushState({page:2}, null, location.href);

    window.addEventListener('popstate', function (event) {
        const goBack = confirm("Warning: your progress will be lost if you go back. Do you wish to continue?");
        if (goBack) {
            // Redirect to main assessments page
            window.location.href = "{{ url_for('main.assessments') }}";
        } else {
            // User cancelled: push dummy state again to block back navigation
            history.pushState({page:2}, null, location.href);
        }
    })

    if (yesBtn) {
        yesBtn.addEventListener('click', function() {
            // hide instructions
            alertBox.style.display = 'none';
            // reveal memory test frame
            testFrame.style.display = 'block';
            // start memorization phase (5s pause)
            window.location.href = "{{ url_for('memory_test.memory_memorize') }}";
        });
    }

    if (noBtn) {
        noBtn.addEventListener('click', function() {
            window.location.href = "{{ url_for('main.assessments') }}";
        });
    }
    // Capture more accurate reaction time using performance.now() and requestAnimationFrame
    let startTime = null;

    function startTimer(timestamp){
        // timestamp will be provided by requestAnimationFrame
        startTime = timestamp;
    }

    window.addEventListener("DOMContentLoaded", () => {
        const choiceButtons = document.querySelectorAll("button[name='choice']");

        if (choiceButtons.length == 0) return;

        // Start timing on the first rendered frame
        requestAnimationFrame(startTimer);
        
        choiceButtons.forEach(button => { 
            button.addEventListener("pointerdown", () => {
                if (startTime !== null) {
                    const reactionTime = performance.now() - startTime;
                    document.getElementById("reaction_time").value = reactionTime.toFixed(2);
                }
            })
        })
    });
</script>
{% endblock %}
